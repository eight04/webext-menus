{"version":3,"file":"webext-menus.js","sources":["../index.js"],"sourcesContent":["const BROWSER = typeof browser !== \"undefined\" ? browser : chrome; // eslint-disable-line no-undef\r\nconst MENUS = BROWSER.menus || BROWSER.contextMenus;\r\nconst ALL_CONTEXTS_EXCLUDE = new Set([\r\n  \"all\",\r\n  \"bookmark\",\r\n  \"browser_action\",\r\n  \"launcher\",\r\n  \"page_action\",\r\n  \"tab\",\r\n  \"tools_menu\"\r\n]);\r\nconst ALL_CONTEXTS = Object.values(MENUS.ContextType)\r\n  .filter(c => !ALL_CONTEXTS_EXCLUDE.has(c));\r\nconst SUPPORT_VISIBLE = (() => {\r\n  try {\r\n    const id = MENUS.create({visible: false});\r\n    MENUS.remove(id);\r\n    return true;\r\n  } catch (err) {\r\n    return false;\r\n  }\r\n})();\r\n\r\nfunction destroy(menu) {\r\n  MENUS.remove(menu.id);\r\n  menu.isCreated = false;\r\n}\r\n\r\nfunction createVisibleUpdater() {\r\n  return {createHidden, toggleVisible};\r\n  \r\n  function createHidden(menu) {\r\n    menu.options.visible = false;\r\n    create(menu);\r\n  }\r\n  \r\n  function toggleVisible(menus) {\r\n    for (const menu of menus) {\r\n      menu.options.visible = menu.show;\r\n      MENUS.update(menu.id, {visible: menu.show});\r\n    }\r\n  }\r\n}\r\n\r\nfunction createLegacyVisibleUpdater() {\r\n  const ids = new Map;\r\n  return {toggleVisible, init};\r\n  \r\n  function toggleVisible(menus) {\r\n    for (const menu of menus) {\r\n      if (!menu.show) {\r\n        destroy(menu);\r\n      }\r\n    }\r\n    \r\n    for (const menu of menus) {\r\n      if (menu.show) {\r\n        if (menu.isCreated) {\r\n          // already processed\r\n          continue;\r\n        }\r\n        destroySiblings(menu);\r\n        create(menu);\r\n        createSiblings(menu);\r\n      }\r\n    }\r\n  }\r\n  \r\n\tfunction destroySiblings(menu) {\r\n\t\tif (!menu.nextSibling) return;\r\n\t\tfor (const nextMenu of Object.values(menu.nextSibling)) {\r\n\t\t\tif (nextMenu.isCreated) {\r\n\t\t\t\tdestroy(nextMenu);\r\n\t\t\t}\r\n\t\t\tdestroySiblings(nextMenu);\r\n\t\t}\r\n\t}\r\n\t\r\n\tfunction createSiblings(menu) {\r\n\t\tif (!menu.nextSibling) return;\r\n\t\tfor (const nextMenu of Object.values(menu.nextSibling)) {\r\n\t\t\tif (!nextMenu.isCreated && nextMenu.show) {\r\n\t\t\t\tcreate(nextMenu);\r\n\t\t\t}\r\n\t\t\tcreateSiblings(nextMenu);\r\n\t\t}\r\n\t}\r\n\t\r\n  function init(menus) {\r\n\t\tconst prevSibling = {};\r\n    for (const menu of menus) {\r\n      // save id\r\n      if (menu.id != null) {\r\n        ids.set(menu.id, menu);\r\n      }\r\n      // build sibling relationship\r\n      for (const context of reduceContextType(getMenuContext(menu))) {\r\n        if (!prevSibling[context]) {\r\n          prevSibling[context] = new Map;\r\n        }\r\n        const prevCmd = prevSibling[context].get(menu.parentId);\r\n        if (prevCmd) {\r\n          if (!prevCmd.nextSibling) {\r\n            prevCmd.nextSibling = {};\r\n          }\r\n          prevCmd.nextSibling[context] = menu;\r\n        }\r\n        prevSibling[context].set(menu.parentId, menu);\r\n      }\r\n    }\r\n  }\r\n  \r\n\tfunction reduceContextType(contexts) {\r\n\t\treturn contexts.reduce((set, context) => {\r\n      if (context === \"all\") {\r\n        ALL_CONTEXTS.forEach(c => set.add(c));\r\n      } else {\r\n        set.add(context);\r\n      }\r\n\t\t\treturn set;\r\n\t\t}, new Set);\r\n\t}\r\n\t\r\n\tfunction getMenuContext(menu) {\r\n\t\tif (menu.contexts) {\r\n\t\t\treturn menu.contexts;\r\n\t\t}\r\n\t\tif (menu.parentId != null) {\r\n\t\t\treturn getMenuContext(ids.get(menu.parentId));\r\n\t\t}\r\n\t\treturn [\"page\"];\r\n\t}\r\n\t\r\n}\r\n\r\nfunction create(menu) {\r\n  menu.id = MENUS.create(Object.assign({}, menu.options));\r\n  menu.isCreated = true;\r\n}\r\n\r\nfunction webextMenus(menus, _SUPPORT_VISIBLE = SUPPORT_VISIBLE) {\r\n\tconst dynamicMenus = [];\r\n  const dynamicChecked = [];\r\n  const visibleUpdater = _SUPPORT_VISIBLE ? createVisibleUpdater() : createLegacyVisibleUpdater();\r\n\t\r\n\tinit(menus);\r\n\t\r\n\tfunction init(menus) {\r\n\t\tfor (const menu of menus) {\r\n\t\t\t// raw options object for browser.menus.create\r\n\t\t\tmenu.options = Object.assign({}, menu);\r\n\t\t\t\r\n      // mark as dynamic checked\r\n      if (typeof menu.checked === \"function\") {\r\n        delete menu.options.checked;\r\n        dynamicChecked.push(menu);\r\n      }\r\n      \r\n\t\t\t// mark as dynamic\r\n\t\t\tif (menu.oncontext) {\r\n        delete menu.options.oncontext;\r\n\t\t\t\tdynamicMenus.push(menu);\r\n        menu.show = false;\r\n        if (visibleUpdater.createHidden) {\r\n          visibleUpdater.createHidden(menu);\r\n        }\r\n\t\t\t} else {\r\n        menu.show = true;\r\n        create(menu);\r\n      }\r\n    }\r\n    \r\n    if (visibleUpdater.init) {\r\n      visibleUpdater.init(menus);\r\n    }\r\n\t}\r\n\t\r\n  function update() {\r\n    updateShown();\r\n    updateChecked();\r\n  }\r\n\t\r\n\tfunction updateShown() {\r\n\t\tconst changed = [];\r\n\t\tfor (const menu of dynamicMenus) {\r\n\t\t\tconst shouldShow = Boolean(menu.oncontext());\r\n\t\t\tif (menu.show === shouldShow) continue;\r\n\t\t\t\r\n      menu.show = shouldShow;\r\n      changed.push(menu);\r\n\t\t}\r\n    visibleUpdater.toggleVisible(changed);\r\n\t}\r\n  \r\n  function updateChecked() {\r\n    for (const menu of dynamicChecked) {\r\n      MENUS.update(menu.id, {checked: menu.checked()});\r\n    }\r\n  }\r\n\t\r\n\treturn {update};\r\n}\r\n\r\nmodule.exports = webextMenus;\r\n"],"names":[],"mappings":"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"}