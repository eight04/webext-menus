{"version":3,"file":"webext-menus.js","sources":["../index.js"],"sourcesContent":["function polyfillVisible(MENUS) {\r\n  const ids = new Map; // Map<id, menu>\r\n  const scopes = new Map; // Map<scopeId, menu>\r\n  const ALL_CONTEXTS = getAllContexts(MENUS);\r\n  return {\r\n    create,\r\n    // remove,\r\n    update,\r\n    commit\r\n  };\r\n  \r\n\tfunction normalizeContexts(contexts) {\r\n    // convert \"all\" to an array of names\r\n\t\treturn contexts.reduce((set, context) => {\r\n      if (context === \"all\") {\r\n        ALL_CONTEXTS.forEach(c => set.add(c));\r\n      } else {\r\n        set.add(context);\r\n      }\r\n\t\t\treturn set;\r\n\t\t}, new Set);\r\n\t}\r\n\t\r\n\tfunction getContexts(menu) {\r\n\t\tif (menu.rawOptions.contexts) {\r\n\t\t\treturn menu.rawOptions.contexts;\r\n\t\t}\r\n\t\tif (menu.rawOptions.parentId != null) {\r\n\t\t\treturn getContexts(ids.get(menu.rawOptions.parentId));\r\n\t\t}\r\n\t\treturn [\"page\"];\r\n\t}\r\n\t\r\n  function create(options, callback) {\r\n    // NOTE: can't reuse the same object since Chrome tries modifying it.\r\n    const id = MENUS.create(Object.assign({}, options), callback);\r\n    const menu = {\r\n      id,\r\n      rawOptions: options,\r\n      visible: true,\r\n      pendingVisible: null,\r\n      prev: [],\r\n      refreshed: false\r\n    };\r\n    ids.set(id, menu);\r\n    for (const contextName of normalizeContexts(getContexts(menu))) {\r\n      const scopeName = `${options.parentId}/${contextName}`;\r\n      const lastMenu = scopes.get(scopeName);\r\n      if (lastMenu) {\r\n        menu.prev.push(lastMenu);\r\n      }\r\n      scopes.set(scopeName, menu);\r\n    }\r\n    return id;\r\n  }\r\n  \r\n  // function remove(id) {\r\n    // FIXME: incomplete API, no one use this\r\n    // ids.delete(id);\r\n    // return MENUS.remove(id);\r\n  // }\r\n  \r\n  function update(id, props) {\r\n    // FIXME: Doesn't support update `contexts`, `parentId`\r\n    const menu = ids.get(id);\r\n    if (props.visible != null) {\r\n      if (props.visible !== menu.visible) {\r\n        menu.pendingVisible = props.visible;\r\n      }\r\n      delete props.visible;\r\n    }\r\n    // FIXME: should we check Object.keys(menu).length and bail out?\r\n    Object.assign(menu.rawOptions, props);\r\n    if (menu.visible) {\r\n      return MENUS.update(id, props);\r\n    }\r\n  }\r\n  \r\n  function commit() {\r\n    // FIXME: we rely on the insertion order. Is it gaurateed in `Set`?\r\n    for (const menu of ids.values()) {\r\n      if (menu.prev.some(m => m.refreshed)) {\r\n        menu.refreshed = true;\r\n        if (menu.pendingVisible == null && menu.visible) {\r\n          // remove static shown menus and create again\r\n          MENUS.remove(menu.id);\r\n          menu.pendingVisible = true;\r\n        }\r\n      }\r\n      if (menu.pendingVisible === false) {\r\n        // remove dynamic menu\r\n        MENUS.remove(menu.id);\r\n        menu.visible = false;\r\n        menu.pendingVisible = null;\r\n      } else if (menu.pendingVisible === true) {\r\n        // show dynamic menu and mark as refreshed\r\n        MENUS.create(menu.rawOptions);\r\n        menu.visible = true;\r\n        menu.pendingVisible = null;\r\n        menu.refreshed = true;\r\n      }\r\n    }\r\n    for (const menu of ids.values()) {\r\n      menu.refreshed = false;\r\n    }\r\n  }\r\n}\r\n\r\nfunction getMenusAPI() {\r\n  const BROWSER = typeof browser !== \"undefined\" ? browser : chrome; // eslint-disable-line no-undef\r\n  return BROWSER.menus || BROWSER.contextMenus;\r\n}\r\n\r\nfunction getAllContexts(MENUS) {\r\n  const ALL_CONTEXTS_EXCLUDE = new Set([\r\n    \"all\",\r\n    \"bookmark\",\r\n    \"browser_action\",\r\n    \"launcher\",\r\n    \"page_action\",\r\n    \"tab\",\r\n    \"tools_menu\"\r\n  ]);\r\n  return Object.values(MENUS.ContextType)\r\n    .filter(c => !ALL_CONTEXTS_EXCLUDE.has(c));\r\n}\r\n\r\nfunction checkVisible(MENUS) {\r\n  let id;\r\n  try {\r\n    id = MENUS.create({visible: false}, () => {\r\n      // eslint-disable-next-line no-undef\r\n      const BROWSER = typeof browser !== \"undefined\" ? browser : chrome;\r\n      if (BROWSER.runtime.lastError) {\r\n        console.warn(\"failed to create menu when checking visible property\", BROWSER.runtime.lastError);\r\n      }\r\n    });\r\n    return true;\r\n  } catch (err) {\r\n    return false;\r\n  } finally {\r\n    if (id != null) {\r\n      MENUS.remove(id); // FIXME: shuould we catch remove errors?\r\n    }\r\n  }\r\n}\r\n\r\nfunction webextMenus(menus, useVisible) {\r\n  const MENUS = getMenusAPI();\r\n\tconst dynamicMenus = [];\r\n  const dynamicChecked = [];\r\n  const API = (useVisible == null ? checkVisible(MENUS) : useVisible) ?\r\n    MENUS : polyfillVisible(MENUS);\r\n\t\r\n  init();\r\n  \r\n\treturn {update};\r\n\t\r\n\tfunction init() {\r\n\t\tfor (const menu of menus) {\r\n\t\t\t// raw options object for browser.menus.create\r\n\t\t\tmenu.options = Object.assign({}, menu);\r\n\t\t\t\r\n      // mark as dynamic checked\r\n      if (typeof menu.checked === \"function\") {\r\n        delete menu.options.checked;\r\n        dynamicChecked.push(menu);\r\n      }\r\n      \r\n\t\t\t// mark as dynamic\r\n\t\t\tif (menu.oncontext) {\r\n        delete menu.options.oncontext;\r\n\t\t\t\tdynamicMenus.push(menu);\r\n        menu.show = false;\r\n        menu.options.visible = false;\r\n\t\t\t} else {\r\n        menu.show = true;\r\n      }\r\n      \r\n      menu.id = menu.options.id = API.create(Object.assign({}, menu.options));\r\n    }\r\n\t}\r\n\t\r\n  function update() {\r\n    updateShown();\r\n    updateChecked();\r\n  }\r\n\t\r\n\tfunction updateShown() {\r\n\t\tfor (const menu of dynamicMenus) {\r\n\t\t\tconst shouldShow = Boolean(menu.oncontext());\r\n\t\t\tif (menu.show === shouldShow) continue;\r\n\t\t\t\r\n      menu.show = shouldShow;\r\n      menu.options.visible = shouldShow;\r\n      API.update(menu.id, {visible: shouldShow});\r\n\t\t}\r\n    if (API.commit) {\r\n      API.commit();\r\n    }\r\n\t}\r\n  \r\n  function updateChecked() {\r\n    for (const menu of dynamicChecked) {\r\n      API.update(menu.id, {checked: menu.checked()});\r\n    }\r\n  }\r\n}\r\n\r\nmodule.exports = webextMenus;\r\n"],"names":[],"mappings":"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"}