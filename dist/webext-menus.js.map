{"version":3,"file":"webext-menus.js","sources":["../index.js"],"sourcesContent":["const BROWSER = typeof browser !== \"undefined\" ? browser : chrome; // eslint-disable-line no-undef\r\nconst MENUS = BROWSER.menus || BROWSER.contextMenus;\r\nconst ALL_CONTEXTS_EXCLUDE = new Set([\r\n  \"all\",\r\n  \"bookmark\",\r\n  \"browser_action\",\r\n  \"launcher\",\r\n  \"page_action\",\r\n  \"tab\",\r\n  \"tools_menu\"\r\n]);\r\nconst ALL_CONTEXTS = Object.values(MENUS.ContextType)\r\n  .filter(c => !ALL_CONTEXTS_EXCLUDE.has(c));\r\n\r\nfunction webextMenus(menus) {\r\n\tconst ids = new Map;\r\n\tconst dynamicMenus = [];\r\n  const dynamicChecked = [];\r\n\t\r\n\tinit(menus);\r\n\t\r\n\tfunction init(menus) {\r\n\t\tconst prevSibling = {};\r\n\t\t\r\n\t\tfor (const menu of menus) {\r\n\t\t\t// save id\r\n\t\t\tif (menu.id != null) {\r\n\t\t\t\tids.set(menu.id, menu);\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\t// raw options object for browser.menus.create\r\n\t\t\tmenu.options = Object.assign({}, menu);\r\n\t\t\t\r\n      // mark as dynamic checked\r\n      if (typeof menu.checked === \"function\") {\r\n        delete menu.options.checked;\r\n        dynamicChecked.push(menu);\r\n      }\r\n\t\t\t\r\n\t\t\t// mark as dynamic\r\n\t\t\tif (menu.oncontext) {\r\n        delete menu.options.oncontext;\r\n\t\t\t\tdynamicMenus.push(menu);\r\n\t\t\t\tmenu.show = false;\r\n\t\t\t} else {\r\n\t\t\t\tcreate(menu);\r\n\t\t\t\tmenu.show = true;\r\n\t\t\t}\r\n      \r\n\t\t\t// build sibling relationship\r\n\t\t\tfor (const context of reduceContextType(getMenuContext(menu))) {\r\n\t\t\t\tif (!prevSibling[context]) {\r\n\t\t\t\t\tprevSibling[context] = new Map;\r\n\t\t\t\t}\r\n\t\t\t\tconst prevCmd = prevSibling[context].get(menu.parentId);\r\n\t\t\t\tif (prevCmd) {\r\n\t\t\t\t\tif (!prevCmd.nextSibling) {\r\n\t\t\t\t\t\tprevCmd.nextSibling = {};\r\n\t\t\t\t\t}\r\n\t\t\t\t\tprevCmd.nextSibling[context] = menu;\r\n\t\t\t\t}\r\n\t\t\t\tprevSibling[context].set(menu.parentId, menu);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\t\r\n\tfunction reduceContextType(contexts) {\r\n\t\treturn contexts.reduce((set, context) => {\r\n      if (context === \"all\") {\r\n        ALL_CONTEXTS.forEach(c => set.add(c));\r\n      } else {\r\n        set.add(context);\r\n      }\r\n\t\t\treturn set;\r\n\t\t}, new Set);\r\n\t}\r\n\t\r\n\tfunction getMenuContext(menu) {\r\n\t\tif (menu.contexts) {\r\n\t\t\treturn menu.contexts;\r\n\t\t}\r\n\t\tif (menu.parentId != null) {\r\n\t\t\treturn getMenuContext(ids.get(menu.parentId));\r\n\t\t}\r\n\t\treturn [\"page\"];\r\n\t}\r\n\t\r\n\tfunction create(menu) {\r\n\t\tmenu.id = MENUS.create(Object.assign({}, menu.options));\r\n\t\tmenu.isCreated = true;\r\n\t}\r\n\t\r\n\tfunction destroy(menu) {\r\n\t\tMENUS.remove(menu.id);\r\n\t\tmenu.isCreated = false;\r\n\t}\r\n  \r\n  function update() {\r\n    updateShown();\r\n    updateChecked();\r\n  }\r\n\t\r\n\tfunction updateShown() {\r\n\t\tconst toShow = [];\r\n\t\tfor (const menu of dynamicMenus) {\r\n\t\t\tconst shouldShow = Boolean(menu.oncontext());\r\n\t\t\tif (menu.show === shouldShow) continue;\r\n\t\t\t\r\n\t\t\tif (shouldShow) {\r\n\t\t\t\ttoShow.push(menu);\r\n\t\t\t\tmenu.show = true;\r\n\t\t\t} else {\r\n\t\t\t\tdestroy(menu);\r\n\t\t\t\tmenu.show = false;\r\n\t\t\t}\r\n\t\t}\r\n\t\tfor (const menu of toShow) {\r\n\t\t\tif (menu.isCreated) {\r\n\t\t\t\t// already processed\r\n\t\t\t\tcontinue;\r\n\t\t\t}\r\n\t\t\tdestroySiblings(menu);\r\n\t\t\tcreate(menu);\r\n\t\t\tcreateSiblings(menu);\r\n\t\t}\r\n\t}\r\n  \r\n  function updateChecked() {\r\n    for (const menu of dynamicChecked) {\r\n      MENUS.update(menu.id, {checked: menu.checked()});\r\n    }\r\n  }\r\n\t\r\n\tfunction destroySiblings(menu) {\r\n\t\tif (!menu.nextSibling) return;\r\n\t\tfor (const nextMenu of Object.values(menu.nextSibling)) {\r\n\t\t\tif (nextMenu.isCreated) {\r\n\t\t\t\tdestroy(nextMenu);\r\n\t\t\t}\r\n\t\t\tdestroySiblings(nextMenu);\r\n\t\t}\r\n\t}\r\n\t\r\n\tfunction createSiblings(menu) {\r\n\t\tif (!menu.nextSibling) return;\r\n\t\tfor (const nextMenu of Object.values(menu.nextSibling)) {\r\n\t\t\tif (!nextMenu.isCreated && nextMenu.show) {\r\n\t\t\t\tcreate(nextMenu);\r\n\t\t\t}\r\n\t\t\tcreateSiblings(nextMenu);\r\n\t\t}\r\n\t}\r\n\t\r\n\treturn {update};\r\n}\r\n\r\nmodule.exports = webextMenus;\r\n"],"names":[],"mappings":"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"}