{"version":3,"file":"webext-menus.js","sources":["../index.js"],"sourcesContent":["/* eslint-env webextensions */\r\n\r\nconst MENUS = browser.menus || browser.contextMenus;\r\nconst ALL_CONTEXTS_EXCLUDE = new Set([\r\n  \"all\",\r\n  \"bookmark\",\r\n  \"browser_action\",\r\n  \"launcher\",\r\n  \"page_action\",\r\n  \"tab\",\r\n  \"tools_menu\"\r\n]);\r\nconst ALL_CONTEXTS = Object.values(MENUS.ContextType)\r\n  .filter(c => !ALL_CONTEXTS_EXCLUDE.has(c));\r\n\r\nfunction webextMenus(menus) {\r\n\tconst ids = new Map;\r\n\tconst dynamicMenus = [];\r\n  const dynamicChecked = [];\r\n\t\r\n\tinit(menus);\r\n\t\r\n\tfunction init(menus) {\r\n\t\tconst prevSibling = {};\r\n\t\t\r\n\t\tfor (const menu of menus) {\r\n\t\t\t// save id\r\n\t\t\tif (menu.id != null) {\r\n\t\t\t\tids.set(menu.id, menu);\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\t// raw options object for browser.menus.create\r\n\t\t\tmenu.options = Object.assign({}, menu);\r\n\t\t\t\r\n      // mark as dynamic checked\r\n      if (typeof menu.checked === \"function\") {\r\n        delete menu.options.checked;\r\n        dynamicChecked.push(menu);\r\n      }\r\n\t\t\t\r\n\t\t\t// mark as dynamic\r\n\t\t\tif (menu.oncontext) {\r\n        delete menu.options.oncontext;\r\n\t\t\t\tdynamicMenus.push(menu);\r\n\t\t\t\tmenu.show = false;\r\n\t\t\t} else {\r\n\t\t\t\tcreate(menu);\r\n\t\t\t\tmenu.show = true;\r\n\t\t\t}\r\n      \r\n\t\t\t// build sibling relationship\r\n\t\t\tfor (const context of reduceContextType(getMenuContext(menu))) {\r\n\t\t\t\tif (!prevSibling[context]) {\r\n\t\t\t\t\tprevSibling[context] = new Map;\r\n\t\t\t\t}\r\n\t\t\t\tconst prevCmd = prevSibling[context].get(menu.parentId);\r\n\t\t\t\tif (prevCmd) {\r\n\t\t\t\t\tif (!prevCmd.nextSibling) {\r\n\t\t\t\t\t\tprevCmd.nextSibling = {};\r\n\t\t\t\t\t}\r\n\t\t\t\t\tprevCmd.nextSibling[context] = menu;\r\n\t\t\t\t}\r\n\t\t\t\tprevSibling[context].set(menu.parentId, menu);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\t\r\n\tfunction reduceContextType(contexts) {\r\n\t\treturn contexts.reduce((set, context) => {\r\n      if (context === \"all\") {\r\n        ALL_CONTEXTS.forEach(c => set.add(c));\r\n      } else {\r\n        set.add(context);\r\n      }\r\n\t\t\treturn set;\r\n\t\t}, new Set);\r\n\t}\r\n\t\r\n\tfunction getMenuContext(menu) {\r\n\t\tif (menu.contexts) {\r\n\t\t\treturn menu.contexts;\r\n\t\t}\r\n\t\tif (menu.parentId != null) {\r\n\t\t\treturn getMenuContext(ids.get(menu.parentId));\r\n\t\t}\r\n\t\treturn [\"page\"];\r\n\t}\r\n\t\r\n\tfunction create(menu) {\r\n\t\tmenu.id = MENUS.create(menu.options);\r\n\t\tmenu.isCreated = true;\r\n\t}\r\n\t\r\n\tfunction destroy(menu) {\r\n\t\tMENUS.remove(menu.id);\r\n\t\tmenu.isCreated = false;\r\n\t}\r\n  \r\n  function update() {\r\n    updateShown();\r\n    updateChecked();\r\n  }\r\n\t\r\n\tfunction updateShown() {\r\n\t\tconst toShow = [];\r\n\t\tfor (const menu of dynamicMenus) {\r\n\t\t\tconst shouldShow = Boolean(menu.oncontext());\r\n\t\t\tif (menu.show === shouldShow) continue;\r\n\t\t\t\r\n\t\t\tif (shouldShow) {\r\n\t\t\t\ttoShow.push(menu);\r\n\t\t\t\tmenu.show = true;\r\n\t\t\t} else {\r\n\t\t\t\tdestroy(menu);\r\n\t\t\t\tmenu.show = false;\r\n\t\t\t}\r\n\t\t}\r\n\t\tfor (const menu of toShow) {\r\n\t\t\tif (menu.isCreated) {\r\n\t\t\t\t// already processed\r\n\t\t\t\tcontinue;\r\n\t\t\t}\r\n\t\t\tdestroySiblings(menu);\r\n\t\t\tcreate(menu);\r\n\t\t\tcreateSiblings(menu);\r\n\t\t}\r\n\t}\r\n  \r\n  function updateChecked() {\r\n    for (const menu of dynamicChecked) {\r\n      MENUS.update(menu.id, {checked: menu.checked()});\r\n    }\r\n  }\r\n\t\r\n\tfunction destroySiblings(menu) {\r\n\t\tif (!menu.nextSibling) return;\r\n\t\tfor (const nextMenu of Object.values(menu.nextSibling)) {\r\n\t\t\tif (nextMenu.isCreated) {\r\n\t\t\t\tdestroy(nextMenu);\r\n\t\t\t}\r\n\t\t\tdestroySiblings(nextMenu);\r\n\t\t}\r\n\t}\r\n\t\r\n\tfunction createSiblings(menu) {\r\n\t\tif (!menu.nextSibling) return;\r\n\t\tfor (const nextMenu of Object.values(menu.nextSibling)) {\r\n\t\t\tif (!nextMenu.isCreated && nextMenu.show) {\r\n\t\t\t\tcreate(nextMenu);\r\n\t\t\t}\r\n\t\t\tcreateSiblings(nextMenu);\r\n\t\t}\r\n\t}\r\n\t\r\n\treturn {update};\r\n}\r\n\r\nmodule.exports = webextMenus;\r\n"],"names":[],"mappings":"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"}