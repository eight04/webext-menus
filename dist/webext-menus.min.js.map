{"version":3,"file":"webext-menus.min.js","sources":["../index.js"],"sourcesContent":["/* eslint-env webextensions */\r\n\r\nconst MENUS = browser.menus || browser.contextMenus;\r\nconst ALL_CONTEXTS_EXCLUDE = new Set([\r\n  \"all\",\r\n  \"bookmark\",\r\n  \"browser_action\",\r\n  \"launcher\",\r\n  \"page_action\",\r\n  \"tab\",\r\n  \"tools_menu\"\r\n]);\r\nconst ALL_CONTEXTS = Object.values(MENUS.ContextType)\r\n  .filter(c => !ALL_CONTEXTS_EXCLUDE.has(c));\r\n\r\nfunction webextMenus(menus) {\r\n\tconst ids = new Map;\r\n\tconst dynamicMenus = [];\r\n\t\r\n\tinit(menus);\r\n\t\r\n\tfunction init(menus) {\r\n\t\tconst prevSibling = {};\r\n\t\t\r\n\t\tfor (const menu of menus) {\r\n\t\t\t// save id\r\n\t\t\tif (menu.id != null) {\r\n\t\t\t\tids.set(menu.id, menu);\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\t// raw options object for browser.menus.create\r\n\t\t\tmenu.options = Object.assign({}, menu);\r\n\t\t\tdelete menu.options.oncontext;\r\n\t\t\t\r\n\t\t\t// mark as dynamic\r\n\t\t\tif (menu.oncontext) {\r\n\t\t\t\tdynamicMenus.push(menu);\r\n\t\t\t\tmenu.show = false;\r\n\t\t\t} else {\r\n\t\t\t\tcreate(menu);\r\n\t\t\t\tmenu.show = true;\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\t// build sibling relationship\r\n\t\t\tfor (const context of reduceContextType(getMenuContext(menu))) {\r\n\t\t\t\tif (!prevSibling[context]) {\r\n\t\t\t\t\tprevSibling[context] = new Map;\r\n\t\t\t\t}\r\n\t\t\t\tconst prevCmd = prevSibling[context].get(menu.parentId);\r\n\t\t\t\tif (prevCmd) {\r\n\t\t\t\t\tif (!prevCmd.nextSibling) {\r\n\t\t\t\t\t\tprevCmd.nextSibling = {};\r\n\t\t\t\t\t}\r\n\t\t\t\t\tprevCmd.nextSibling[context] = menu;\r\n\t\t\t\t}\r\n\t\t\t\tprevSibling[context].set(menu.parentId, menu);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\t\r\n\tfunction reduceContextType(contexts) {\r\n\t\treturn contexts.reduce((set, context) => {\r\n      if (context === \"all\") {\r\n        ALL_CONTEXTS.forEach(c => set.add(c));\r\n      } else {\r\n        set.add(context);\r\n      }\r\n\t\t\treturn set;\r\n\t\t}, new Set);\r\n\t}\r\n\t\r\n\tfunction getMenuContext(menu) {\r\n\t\tif (menu.contexts) {\r\n\t\t\treturn menu.contexts;\r\n\t\t}\r\n\t\tif (menu.parentId != null) {\r\n\t\t\treturn getMenuContext(ids.get(menu.parentId));\r\n\t\t}\r\n\t\treturn [\"page\"];\r\n\t}\r\n\t\r\n\tfunction create(menu) {\r\n\t\tmenu.id = MENUS.create(menu.options);\r\n\t\tmenu.isCreated = true;\r\n\t}\r\n\t\r\n\tfunction destroy(menu) {\r\n\t\tMENUS.remove(menu.id);\r\n\t\tmenu.isCreated = false;\r\n\t}\r\n\t\r\n\tfunction update() {\r\n\t\tconst toShow = [];\r\n\t\tfor (const menu of dynamicMenus) {\r\n\t\t\tconst shouldShow = Boolean(menu.oncontext());\r\n\t\t\tif (menu.show === shouldShow) continue;\r\n\t\t\t\r\n\t\t\tif (shouldShow) {\r\n\t\t\t\ttoShow.push(menu);\r\n\t\t\t\tmenu.show = true;\r\n\t\t\t} else {\r\n\t\t\t\tdestroy(menu);\r\n\t\t\t\tmenu.show = false;\r\n\t\t\t}\r\n\t\t}\r\n\t\tfor (const menu of toShow) {\r\n\t\t\tif (menu.isCreated) {\r\n\t\t\t\t// already processed\r\n\t\t\t\tcontinue;\r\n\t\t\t}\r\n\t\t\tdestroySiblings(menu);\r\n\t\t\tcreate(menu);\r\n\t\t\tcreateSiblings(menu);\r\n\t\t}\r\n\t}\r\n\t\r\n\tfunction destroySiblings(menu) {\r\n\t\tif (!menu.nextSibling) return;\r\n\t\tfor (const nextMenu of Object.values(menu.nextSibling)) {\r\n\t\t\tif (nextMenu.isCreated) {\r\n\t\t\t\tdestroy(nextMenu);\r\n\t\t\t}\r\n\t\t\tdestroySiblings(nextMenu);\r\n\t\t}\r\n\t}\r\n\t\r\n\tfunction createSiblings(menu) {\r\n\t\tif (!menu.nextSibling) return;\r\n\t\tfor (const nextMenu of Object.values(menu.nextSibling)) {\r\n\t\t\tif (!nextMenu.isCreated && nextMenu.show) {\r\n\t\t\t\tcreate(nextMenu);\r\n\t\t\t}\r\n\t\t\tcreateSiblings(nextMenu);\r\n\t\t}\r\n\t}\r\n\t\r\n\treturn {update};\r\n}\r\n\r\nmodule.exports = webextMenus;\r\n"],"names":["MENUS","browser","menus","contextMenus","ALL_CONTEXTS_EXCLUDE","Set","ALL_CONTEXTS","Object","values","ContextType","filter","c","has","getMenuContext","menu","contexts","parentId","ids","get","create","id","options","isCreated","destroy","remove","destroySiblings","nextSibling","nextMenu","createSiblings","show","Map","dynamicMenus","prevSibling","set","assign","oncontext","push","context","reduce","forEach","add","reduceContextType","prevCmd","init","update","toShow","shouldShow","Boolean"],"mappings":"wCAEA,MAAMA,EAAQC,QAAQC,OAASD,QAAQE,aACjCC,EAAuB,IAAIC,KAC/B,MACA,WACA,iBACA,WACA,cACA,MACA,eAEIC,EAAeC,OAAOC,OAAOR,EAAMS,aACtCC,OAAOC,IAAMP,EAAqBQ,IAAID,WAEzC,SAAqBT,GAwDpB,SAASW,EAAeC,GACvB,OAAIA,EAAKC,SACDD,EAAKC,SAEQ,MAAjBD,EAAKE,SACDH,EAAeI,EAAIC,IAAIJ,EAAKE,YAE5B,QAGT,SAASG,EAAOL,GACfA,EAAKM,GAAKpB,EAAMmB,OAAOL,EAAKO,SAC5BP,EAAKQ,WAAY,EAGlB,SAASC,EAAQT,GAChBd,EAAMwB,OAAOV,EAAKM,IAClBN,EAAKQ,WAAY,EA4BlB,SAASG,EAAgBX,GACxB,GAAKA,EAAKY,YACV,IAAK,MAAMC,KAAYpB,OAAOC,OAAOM,EAAKY,aACrCC,EAASL,WACZC,EAAQI,GAETF,EAAgBE,GAIlB,SAASC,EAAed,GACvB,GAAKA,EAAKY,YACV,IAAK,MAAMC,KAAYpB,OAAOC,OAAOM,EAAKY,cACpCC,EAASL,WAAaK,EAASE,MACnCV,EAAOQ,GAERC,EAAeD,GApHjB,MAAMV,EAAM,IAAIa,IACVC,KAuHN,OAnHA,SAAc7B,GACb,MAAM8B,KAEN,IAAK,MAAMlB,KAAQZ,EAAO,CAEV,MAAXY,EAAKM,IACRH,EAAIgB,IAAInB,EAAKM,GAAIN,GAIlBA,EAAKO,QAAUd,OAAO2B,UAAWpB,UAC1BA,EAAKO,QAAQc,UAGhBrB,EAAKqB,WACRJ,EAAaK,KAAKtB,GAClBA,EAAKe,MAAO,IAEZV,EAAOL,GACPA,EAAKe,MAAO,GAIb,IAAK,MAAMQ,KAgBb,SAA2BtB,GAC1B,OAAOA,EAASuB,OAAO,CAACL,EAAKI,KACT,QAAZA,EACF/B,EAAaiC,QAAQ5B,GAAKsB,EAAIO,IAAI7B,IAElCsB,EAAIO,IAAIH,GAENJ,GACL,IAAI5B,KAxBgBoC,CAAkB5B,EAAeC,IAAQ,CACzDkB,EAAYK,KAChBL,EAAYK,GAAW,IAAIP,KAE5B,MAAMY,EAAUV,EAAYK,GAASnB,IAAIJ,EAAKE,UAC1C0B,IACEA,EAAQhB,cACZgB,EAAQhB,gBAETgB,EAAQhB,YAAYW,GAAWvB,GAEhCkB,EAAYK,GAASJ,IAAInB,EAAKE,SAAUF,KApC3C6B,CAAKzC,IAqHG0C,OA7CR,WACC,MAAMC,KACN,IAAK,MAAM/B,KAAQiB,EAAc,CAChC,MAAMe,EAAaC,QAAQjC,EAAKqB,aAC5BrB,EAAKe,OAASiB,IAEdA,GACHD,EAAOT,KAAKtB,GACZA,EAAKe,MAAO,IAEZN,EAAQT,GACRA,EAAKe,MAAO,IAGd,IAAK,MAAMf,KAAQ+B,EACd/B,EAAKQ,YAITG,EAAgBX,GAChBK,EAAOL,GACPc,EAAed"}