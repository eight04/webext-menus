{"version":3,"file":"webext-menus.min.js","sources":["../index.js"],"sourcesContent":["/* eslint-env webextensions */\r\n\r\nconst SPECIAL_CONTEXTS = new Set([\"bookmark\", \"browser_action\", \"page_action\", \"tab\", \"tools_menu\"]);\r\nconst MENUS = browser.menus || browser.contextMenus;\r\n\r\nfunction webextMenus(menus) {\r\n\tconst ids = new Map;\r\n\tconst dynamicMenus = [];\r\n\t\r\n\tinit(menus);\r\n\t\r\n\tfunction init(menus) {\r\n\t\tconst prevSibling = {};\r\n\t\t\r\n\t\tfor (const menu of menus) {\r\n\t\t\t// save id\r\n\t\t\tif (menu.id != null) {\r\n\t\t\t\tids.set(menu.id, menu);\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\t// raw options object for browser.menus.create\r\n\t\t\tmenu.options = Object.assign({}, menu);\r\n\t\t\tdelete menu.options.oncontext;\r\n\t\t\t\r\n\t\t\t// mark as dynamic\r\n\t\t\tif (menu.oncontext) {\r\n\t\t\t\tdynamicMenus.push(menu);\r\n\t\t\t\tmenu.show = false;\r\n\t\t\t} else {\r\n\t\t\t\tcreate(menu);\r\n\t\t\t\tmenu.show = true;\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\t// build sibling relationship\r\n\t\t\tfor (const context of reduceContextType(getMenuContext(menu))) {\r\n\t\t\t\tif (!prevSibling[context]) {\r\n\t\t\t\t\tprevSibling[context] = new Map;\r\n\t\t\t\t}\r\n\t\t\t\tconst prevCmd = prevSibling[context].get(menu.parentId);\r\n\t\t\t\tif (prevCmd) {\r\n\t\t\t\t\tif (!prevCmd.nextSibling) {\r\n\t\t\t\t\t\tprevCmd.nextSibling = {};\r\n\t\t\t\t\t}\r\n\t\t\t\t\tprevCmd.nextSibling[context] = menu;\r\n\t\t\t\t}\r\n\t\t\t\tprevSibling[context].set(menu.parentId, menu);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\t\r\n\tfunction reduceContextType(contexts) {\r\n\t\treturn contexts.reduce((set, context) => {\r\n\t\t\tset.add(SPECIAL_CONTEXTS.has(context) ? context : \"webpage\");\r\n\t\t\treturn set;\r\n\t\t}, new Set);\r\n\t}\r\n\t\r\n\tfunction getMenuContext(menu) {\r\n\t\tif (menu.contexts) {\r\n\t\t\treturn menu.contexts;\r\n\t\t}\r\n\t\tif (menu.parentId != null) {\r\n\t\t\treturn getMenuContext(ids.get(menu.parentId));\r\n\t\t}\r\n\t\treturn [\"page\"];\r\n\t}\r\n\t\r\n\tfunction create(menu) {\r\n\t\tmenu.id = MENUS.create(menu.options);\r\n\t\tmenu.isCreated = true;\r\n\t}\r\n\t\r\n\tfunction destroy(menu) {\r\n\t\tMENUS.remove(menu.id);\r\n\t\tmenu.isCreated = false;\r\n\t}\r\n\t\r\n\tfunction update() {\r\n\t\tconst toShow = [];\r\n\t\tfor (const menu of dynamicMenus) {\r\n\t\t\tconst shouldShow = Boolean(menu.oncontext());\r\n\t\t\tif (menu.show === shouldShow) continue;\r\n\t\t\t\r\n\t\t\tif (shouldShow) {\r\n\t\t\t\ttoShow.push(menu);\r\n\t\t\t\tmenu.show = true;\r\n\t\t\t} else {\r\n\t\t\t\tdestroy(menu);\r\n\t\t\t\tmenu.show = false;\r\n\t\t\t}\r\n\t\t}\r\n\t\tfor (const menu of toShow) {\r\n\t\t\tif (menu.isCreated) {\r\n\t\t\t\t// already processed\r\n\t\t\t\tcontinue;\r\n\t\t\t}\r\n\t\t\tdestroySiblings(menu);\r\n\t\t\tcreate(menu);\r\n\t\t\tcreateSiblings(menu);\r\n\t\t}\r\n\t}\r\n\t\r\n\tfunction destroySiblings(menu) {\r\n\t\tif (!menu.nextSibling) return;\r\n\t\tfor (const nextMenu of Object.values(menu.nextSibling)) {\r\n\t\t\tif (nextMenu.isCreated) {\r\n\t\t\t\tdestroy(nextMenu);\r\n\t\t\t}\r\n\t\t\tdestroySiblings(nextMenu);\r\n\t\t}\r\n\t}\r\n\t\r\n\tfunction createSiblings(menu) {\r\n\t\tif (!menu.nextSibling) return;\r\n\t\tfor (const nextMenu of Object.values(menu.nextSibling)) {\r\n\t\t\tif (!nextMenu.isCreated && nextMenu.show) {\r\n\t\t\t\tcreate(nextMenu);\r\n\t\t\t}\r\n\t\t\tcreateSiblings(nextMenu);\r\n\t\t}\r\n\t}\r\n\t\r\n\treturn {update};\r\n}\r\n\r\nmodule.exports = webextMenus;\r\n"],"names":["SPECIAL_CONTEXTS","Set","MENUS","browser","menus","contextMenus","ids","Map","dynamicMenus","getMenuContext","menu","contexts","parentId","get","create","id","options","isCreated","destroy","remove","destroySiblings","nextSibling","nextMenu","Object","values","createSiblings","show","prevSibling","set","assign","oncontext","push","context","reduce","add","has","prevCmd","init","update","toShow","shouldShow","Boolean"],"mappings":"wCAEA,MAAMA,EAAmB,IAAIC,KAAK,WAAY,iBAAkB,cAAe,MAAO,eAChFC,EAAQC,QAAQC,OAASD,QAAQE,oBAEvC,SAAqBD,GACpB,MAAME,EAAM,IAAIC,IACVC,KAkDN,SAASC,EAAeC,GACvB,OAAIA,EAAKC,SACDD,EAAKC,SAEQ,MAAjBD,EAAKE,SACDH,EAAeH,EAAIO,IAAIH,EAAKE,YAE5B,QAGT,SAASE,EAAOJ,GACfA,EAAKK,GAAKb,EAAMY,OAAOJ,EAAKM,SAC5BN,EAAKO,WAAY,EAGlB,SAASC,EAAQR,GAChBR,EAAMiB,OAAOT,EAAKK,IAClBL,EAAKO,WAAY,EA4BlB,SAASG,EAAgBV,GACxB,GAAKA,EAAKW,YACV,IAAK,MAAMC,KAAYC,OAAOC,OAAOd,EAAKW,aACrCC,EAASL,WACZC,EAAQI,GAETF,EAAgBE,GAIlB,SAASG,EAAef,GACvB,GAAKA,EAAKW,YACV,IAAK,MAAMC,KAAYC,OAAOC,OAAOd,EAAKW,cACpCC,EAASL,WAAaK,EAASI,MACnCZ,EAAOQ,GAERG,EAAeH,GAIjB,OA/GA,SAAclB,GACb,MAAMuB,KAEN,IAAK,MAAMjB,KAAQN,EAAO,CAEV,MAAXM,EAAKK,IACRT,EAAIsB,IAAIlB,EAAKK,GAAIL,GAIlBA,EAAKM,QAAUO,OAAOM,UAAWnB,UAC1BA,EAAKM,QAAQc,UAGhBpB,EAAKoB,WACRtB,EAAauB,KAAKrB,GAClBA,EAAKgB,MAAO,IAEZZ,EAAOJ,GACPA,EAAKgB,MAAO,GAIb,IAAK,MAAMM,KAgBcrB,EAhBeF,EAAeC,GAiBjDC,EAASsB,OAAO,CAACL,EAAKI,KAC5BJ,EAAIM,IAAIlC,EAAiBmC,IAAIH,GAAWA,EAAU,WAC3CJ,GACL,IAAI3B,KApByD,CACzD0B,EAAYK,KAChBL,EAAYK,GAAW,IAAIzB,KAE5B,MAAM6B,EAAUT,EAAYK,GAASnB,IAAIH,EAAKE,UAC1CwB,IACEA,EAAQf,cACZe,EAAQf,gBAETe,EAAQf,YAAYW,GAAWtB,GAEhCiB,EAAYK,GAASJ,IAAIlB,EAAKE,SAAUF,IAK3C,IAA2BC,EAzC3B0B,CAAKjC,IAiHGkC,OA7CR,WACC,MAAMC,KACN,IAAK,MAAM7B,KAAQF,EAAc,CAChC,MAAMgC,EAAaC,QAAQ/B,EAAKoB,aAC5BpB,EAAKgB,OAASc,IAEdA,GACHD,EAAOR,KAAKrB,GACZA,EAAKgB,MAAO,IAEZR,EAAQR,GACRA,EAAKgB,MAAO,IAGd,IAAK,MAAMhB,KAAQ6B,EACd7B,EAAKO,YAITG,EAAgBV,GAChBI,EAAOJ,GACPe,EAAef"}