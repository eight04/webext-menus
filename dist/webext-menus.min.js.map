{"version":3,"file":"webext-menus.min.js","sources":["../index.js"],"sourcesContent":["/* eslint-env webextensions */\r\n\r\nconst MENUS = browser.menus || browser.contextMenus;\r\nconst ALL_CONTEXTS_EXCLUDE = new Set([\r\n  \"all\",\r\n  \"bookmark\",\r\n  \"browser_action\",\r\n  \"launcher\",\r\n  \"page_action\",\r\n  \"tab\",\r\n  \"tools_menu\"\r\n]);\r\nconst ALL_CONTEXTS = Object.values(MENUS.ContextType)\r\n  .filter(c => !ALL_CONTEXTS_EXCLUDE.has(c));\r\n\r\nfunction webextMenus(menus) {\r\n\tconst ids = new Map;\r\n\tconst dynamicMenus = [];\r\n  const dynamicChecked = [];\r\n\t\r\n\tinit(menus);\r\n\t\r\n\tfunction init(menus) {\r\n\t\tconst prevSibling = {};\r\n\t\t\r\n\t\tfor (const menu of menus) {\r\n\t\t\t// save id\r\n\t\t\tif (menu.id != null) {\r\n\t\t\t\tids.set(menu.id, menu);\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\t// raw options object for browser.menus.create\r\n\t\t\tmenu.options = Object.assign({}, menu);\r\n\t\t\t\r\n      // mark as dynamic checked\r\n      if (typeof menu.checked === \"function\") {\r\n        delete menu.options.checked;\r\n        dynamicChecked.push(menu);\r\n      }\r\n\t\t\t\r\n\t\t\t// mark as dynamic\r\n\t\t\tif (menu.oncontext) {\r\n        delete menu.options.oncontext;\r\n\t\t\t\tdynamicMenus.push(menu);\r\n\t\t\t\tmenu.show = false;\r\n\t\t\t} else {\r\n\t\t\t\tcreate(menu);\r\n\t\t\t\tmenu.show = true;\r\n\t\t\t}\r\n      \r\n\t\t\t// build sibling relationship\r\n\t\t\tfor (const context of reduceContextType(getMenuContext(menu))) {\r\n\t\t\t\tif (!prevSibling[context]) {\r\n\t\t\t\t\tprevSibling[context] = new Map;\r\n\t\t\t\t}\r\n\t\t\t\tconst prevCmd = prevSibling[context].get(menu.parentId);\r\n\t\t\t\tif (prevCmd) {\r\n\t\t\t\t\tif (!prevCmd.nextSibling) {\r\n\t\t\t\t\t\tprevCmd.nextSibling = {};\r\n\t\t\t\t\t}\r\n\t\t\t\t\tprevCmd.nextSibling[context] = menu;\r\n\t\t\t\t}\r\n\t\t\t\tprevSibling[context].set(menu.parentId, menu);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\t\r\n\tfunction reduceContextType(contexts) {\r\n\t\treturn contexts.reduce((set, context) => {\r\n      if (context === \"all\") {\r\n        ALL_CONTEXTS.forEach(c => set.add(c));\r\n      } else {\r\n        set.add(context);\r\n      }\r\n\t\t\treturn set;\r\n\t\t}, new Set);\r\n\t}\r\n\t\r\n\tfunction getMenuContext(menu) {\r\n\t\tif (menu.contexts) {\r\n\t\t\treturn menu.contexts;\r\n\t\t}\r\n\t\tif (menu.parentId != null) {\r\n\t\t\treturn getMenuContext(ids.get(menu.parentId));\r\n\t\t}\r\n\t\treturn [\"page\"];\r\n\t}\r\n\t\r\n\tfunction create(menu) {\r\n\t\tmenu.id = MENUS.create(Object.assign({}, menu.options));\r\n\t\tmenu.isCreated = true;\r\n\t}\r\n\t\r\n\tfunction destroy(menu) {\r\n\t\tMENUS.remove(menu.id);\r\n\t\tmenu.isCreated = false;\r\n\t}\r\n  \r\n  function update() {\r\n    updateShown();\r\n    updateChecked();\r\n  }\r\n\t\r\n\tfunction updateShown() {\r\n\t\tconst toShow = [];\r\n\t\tfor (const menu of dynamicMenus) {\r\n\t\t\tconst shouldShow = Boolean(menu.oncontext());\r\n\t\t\tif (menu.show === shouldShow) continue;\r\n\t\t\t\r\n\t\t\tif (shouldShow) {\r\n\t\t\t\ttoShow.push(menu);\r\n\t\t\t\tmenu.show = true;\r\n\t\t\t} else {\r\n\t\t\t\tdestroy(menu);\r\n\t\t\t\tmenu.show = false;\r\n\t\t\t}\r\n\t\t}\r\n\t\tfor (const menu of toShow) {\r\n\t\t\tif (menu.isCreated) {\r\n\t\t\t\t// already processed\r\n\t\t\t\tcontinue;\r\n\t\t\t}\r\n\t\t\tdestroySiblings(menu);\r\n\t\t\tcreate(menu);\r\n\t\t\tcreateSiblings(menu);\r\n\t\t}\r\n\t}\r\n  \r\n  function updateChecked() {\r\n    for (const menu of dynamicChecked) {\r\n      MENUS.update(menu.id, {checked: menu.checked()});\r\n    }\r\n  }\r\n\t\r\n\tfunction destroySiblings(menu) {\r\n\t\tif (!menu.nextSibling) return;\r\n\t\tfor (const nextMenu of Object.values(menu.nextSibling)) {\r\n\t\t\tif (nextMenu.isCreated) {\r\n\t\t\t\tdestroy(nextMenu);\r\n\t\t\t}\r\n\t\t\tdestroySiblings(nextMenu);\r\n\t\t}\r\n\t}\r\n\t\r\n\tfunction createSiblings(menu) {\r\n\t\tif (!menu.nextSibling) return;\r\n\t\tfor (const nextMenu of Object.values(menu.nextSibling)) {\r\n\t\t\tif (!nextMenu.isCreated && nextMenu.show) {\r\n\t\t\t\tcreate(nextMenu);\r\n\t\t\t}\r\n\t\t\tcreateSiblings(nextMenu);\r\n\t\t}\r\n\t}\r\n\t\r\n\treturn {update};\r\n}\r\n\r\nmodule.exports = webextMenus;\r\n"],"names":["MENUS","browser","menus","contextMenus","ALL_CONTEXTS_EXCLUDE","Set","ALL_CONTEXTS","Object","values","ContextType","filter","c","has","ids","Map","dynamicMenus","dynamicChecked","getMenuContext","menu","contexts","parentId","get","create","id","assign","options","isCreated","destroy","remove","destroySiblings","nextSibling","nextMenu","createSiblings","show","prevSibling","set","checked","push","oncontext","context","reduce","forEach","add","prevCmd","init","update","toShow","shouldShow","Boolean","updateShown","updateChecked"],"mappings":"wCAEA,MAAMA,EAAQC,QAAQC,OAASD,QAAQE,aACjCC,EAAuB,IAAIC,KAC/B,MACA,WACA,iBACA,WACA,cACA,MACA,eAEIC,EAAeC,OAAOC,OAAOR,EAAMS,aACtCC,OAAOC,IAAMP,EAAqBQ,IAAID,WAEzC,SAAqBT,GACpB,MAAMW,EAAM,IAAIC,IACVC,KACCC,KA4DP,SAASC,EAAeC,GACvB,OAAIA,EAAKC,SACDD,EAAKC,SAEQ,MAAjBD,EAAKE,SACDH,EAAeJ,EAAIQ,IAAIH,EAAKE,YAE5B,QAGT,SAASE,EAAOJ,GACfA,EAAKK,GAAKvB,EAAMsB,OAAOf,OAAOiB,UAAWN,EAAKO,UAC9CP,EAAKQ,WAAY,EAGlB,SAASC,EAAQT,GAChBlB,EAAM4B,OAAOV,EAAKK,IAClBL,EAAKQ,WAAY,EAuClB,SAASG,EAAgBX,GACxB,GAAKA,EAAKY,YACV,IAAK,MAAMC,KAAYxB,OAAOC,OAAOU,EAAKY,aACrCC,EAASL,WACZC,EAAQI,GAETF,EAAgBE,GAIlB,SAASC,EAAed,GACvB,GAAKA,EAAKY,YACV,IAAK,MAAMC,KAAYxB,OAAOC,OAAOU,EAAKY,cACpCC,EAASL,WAAaK,EAASE,MACnCX,EAAOS,GAERC,EAAeD,GAIjB,OApIA,SAAc7B,GACb,MAAMgC,KAEN,IAAK,MAAMhB,KAAQhB,EAAO,CAEV,MAAXgB,EAAKK,IACRV,EAAIsB,IAAIjB,EAAKK,GAAIL,GAIlBA,EAAKO,QAAUlB,OAAOiB,UAAWN,GAGF,mBAAjBA,EAAKkB,iBACPlB,EAAKO,QAAQW,QACpBpB,EAAeqB,KAAKnB,IAIrBA,EAAKoB,kBACGpB,EAAKO,QAAQa,UACxBvB,EAAasB,KAAKnB,GAClBA,EAAKe,MAAO,IAEZX,EAAOJ,GACPA,EAAKe,MAAO,GAIb,IAAK,MAAMM,KAA6BtB,EAAeC,GAiBxCsB,OAAO,CAACL,EAAKI,KACT,QAAZA,EACFjC,EAAamC,QAAQ9B,GAAKwB,EAAIO,IAAI/B,IAElCwB,EAAIO,IAAIH,GAENJ,GACL,IAAI9B,KAxByD,CACzD6B,EAAYK,KAChBL,EAAYK,GAAW,IAAIzB,KAE5B,MAAM6B,EAAUT,EAAYK,GAASlB,IAAIH,EAAKE,UAC1CuB,IACEA,EAAQb,cACZa,EAAQb,gBAETa,EAAQb,YAAYS,GAAWrB,GAEhCgB,EAAYK,GAASJ,IAAIjB,EAAKE,SAAUF,KA1C3C0B,CAAK1C,IAsIG2C,OAxDP,YAKD,WACC,MAAMC,KACN,IAAK,MAAM5B,KAAQH,EAAc,CAChC,MAAMgC,EAAaC,QAAQ9B,EAAKoB,aAC5BpB,EAAKe,OAASc,IAEdA,GACHD,EAAOT,KAAKnB,GACZA,EAAKe,MAAO,IAEZN,EAAQT,GACRA,EAAKe,MAAO,IAGd,IAAK,MAAMf,KAAQ4B,EACd5B,EAAKQ,YAITG,EAAgBX,GAChBI,EAAOJ,GACPc,EAAed,IAzBd+B,GA6BF,WACE,IAAK,MAAM/B,KAAQF,EACjBhB,EAAM6C,OAAO3B,EAAKK,IAAKa,QAASlB,EAAKkB,YA9BvCc"}