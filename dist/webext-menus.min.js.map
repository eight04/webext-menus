{"version":3,"file":"webext-menus.min.js","sources":["../index.js"],"sourcesContent":["function polyfillVisible(MENUS) {\r\n  const ids = new Map; // Map<id, menu>\r\n  const scopes = new Map; // Map<scopeId, menu>\r\n  const ALL_CONTEXTS = getAllContexts(MENUS);\r\n  let INC = 1;\r\n  return {\r\n    create,\r\n    // remove,\r\n    update,\r\n    commit\r\n  };\r\n  \r\n\tfunction normalizeContexts(contexts) {\r\n    // convert \"all\" to an array of names\r\n\t\treturn contexts.reduce((set, context) => {\r\n      if (context === \"all\") {\r\n        ALL_CONTEXTS.forEach(c => set.add(c));\r\n      } else {\r\n        set.add(context);\r\n      }\r\n\t\t\treturn set;\r\n\t\t}, new Set);\r\n\t}\r\n\t\r\n\tfunction getContexts(menu) {\r\n\t\tif (menu.rawOptions.contexts) {\r\n\t\t\treturn menu.rawOptions.contexts;\r\n\t\t}\r\n\t\tif (menu.rawOptions.parentId != null) {\r\n\t\t\treturn getContexts(ids.get(menu.rawOptions.parentId));\r\n\t\t}\r\n\t\treturn [\"page\"];\r\n\t}\r\n\t\r\n  function create(options) {\r\n    const visible = options.visible !== false;\r\n    delete options.visible;\r\n    options.id = options.id || `WEBEXT_MENUS/${INC++}`;\r\n    // NOTE: can't reuse the same object since Chrome tries modifying it.\r\n    if (visible) {\r\n      MENUS.create(Object.assign({}, options));\r\n    }\r\n    const menu = {\r\n      id: options.id,\r\n      rawOptions: options,\r\n      visible,\r\n      pendingVisible: null,\r\n      prev: [],\r\n      refreshed: false\r\n    };\r\n    ids.set(options.id, menu);\r\n    for (const contextName of normalizeContexts(getContexts(menu))) {\r\n      const scopeName = `${options.parentId}/${contextName}`;\r\n      const lastMenu = scopes.get(scopeName);\r\n      if (lastMenu) {\r\n        menu.prev.push(lastMenu);\r\n      }\r\n      scopes.set(scopeName, menu);\r\n    }\r\n    return options.id;\r\n  }\r\n  \r\n  function update(id, props) {\r\n    // FIXME: Doesn't support update `contexts`, `parentId`\r\n    const menu = ids.get(id);\r\n    if (props.visible != null) {\r\n      if (props.visible !== menu.visible) {\r\n        menu.pendingVisible = props.visible;\r\n      }\r\n      delete props.visible;\r\n    }\r\n    // FIXME: should we check Object.keys(menu).length and bail out?\r\n    Object.assign(menu.rawOptions, props);\r\n    if (menu.visible) {\r\n      return MENUS.update(id, props);\r\n    }\r\n  }\r\n  \r\n  function commit() {\r\n    // FIXME: we rely on the insertion order. Is it gaurateed in `Set`?\r\n    for (const menu of ids.values()) {\r\n      if (menu.prev.some(m => m.refreshed)) {\r\n        menu.refreshed = true;\r\n        if (menu.pendingVisible == null && menu.visible) {\r\n          // remove static shown menus and create again\r\n          MENUS.remove(menu.id);\r\n          menu.pendingVisible = true;\r\n        }\r\n      }\r\n      if (menu.pendingVisible === false) {\r\n        // remove dynamic menu\r\n        MENUS.remove(menu.id);\r\n        menu.visible = false;\r\n        menu.pendingVisible = null;\r\n      } else if (menu.pendingVisible === true) {\r\n        // show dynamic menu and mark as refreshed\r\n        MENUS.create(Object.assign({}, menu.rawOptions));\r\n        menu.visible = true;\r\n        menu.pendingVisible = null;\r\n        menu.refreshed = true;\r\n      }\r\n    }\r\n    for (const menu of ids.values()) {\r\n      menu.refreshed = false;\r\n    }\r\n  }\r\n}\r\n\r\nfunction getMenusAPI() {\r\n  const BROWSER = typeof browser !== \"undefined\" ? browser : chrome; // eslint-disable-line no-undef\r\n  return BROWSER.menus || BROWSER.contextMenus;\r\n}\r\n\r\nfunction getAllContexts(MENUS) {\r\n  const ALL_CONTEXTS_EXCLUDE = new Set([\r\n    \"all\",\r\n    \"bookmark\",\r\n    \"browser_action\",\r\n    \"launcher\",\r\n    \"page_action\",\r\n    \"tab\",\r\n    \"tools_menu\"\r\n  ]);\r\n  return Object.values(MENUS.ContextType)\r\n    .filter(c => !ALL_CONTEXTS_EXCLUDE.has(c));\r\n}\r\n\r\nfunction checkVisible(MENUS) {\r\n  let id;\r\n  try {\r\n    id = MENUS.create({visible: false, title: \"test_visible\"}, () => {\r\n      // eslint-disable-next-line no-undef\r\n      const BROWSER = typeof browser !== \"undefined\" ? browser : chrome;\r\n      if (BROWSER.runtime.lastError) {\r\n        console.warn(\"failed to create menu when checking visible property\", BROWSER.runtime.lastError);\r\n      }\r\n    });\r\n    return true;\r\n  } catch (err) {\r\n    return false;\r\n  } finally {\r\n    if (id != null) {\r\n      MENUS.remove(id); // FIXME: shuould we catch remove errors?\r\n    }\r\n  }\r\n}\r\n\r\nfunction webextMenus(menus, useVisible) {\r\n  const MENUS = getMenusAPI();\r\n\tconst dynamicMenus = [];\r\n  const dynamicChecked = [];\r\n  const API = (useVisible == null ? checkVisible(MENUS) : useVisible) ?\r\n    MENUS : polyfillVisible(MENUS);\r\n\t\r\n  init();\r\n  \r\n\treturn {update};\r\n\t\r\n\tfunction init() {\r\n\t\tfor (const menu of menus) {\r\n\t\t\t// raw options object for browser.menus.create\r\n\t\t\tconst options = Object.assign({}, menu);\r\n\t\t\t\r\n      // mark as dynamic checked\r\n      if (typeof menu.checked === \"function\") {\r\n        delete options.checked;\r\n        dynamicChecked.push(menu);\r\n      }\r\n      \r\n\t\t\t// mark as dynamic\r\n\t\t\tif (menu.oncontext) {\r\n        delete options.oncontext;\r\n\t\t\t\tdynamicMenus.push(menu);\r\n        menu.show = false;\r\n        options.visible = false;\r\n\t\t\t} else {\r\n        menu.show = true;\r\n      }\r\n      \r\n      menu.id = API.create(options);\r\n    }\r\n\t}\r\n\t\r\n  function update() {\r\n    updateShown();\r\n    updateChecked();\r\n  }\r\n\t\r\n\tfunction updateShown() {\r\n\t\tfor (const menu of dynamicMenus) {\r\n\t\t\tconst shouldShow = Boolean(menu.oncontext());\r\n\t\t\tif (menu.show === shouldShow) continue;\r\n\t\t\t\r\n      menu.show = shouldShow;\r\n      API.update(menu.id, {visible: shouldShow});\r\n\t\t}\r\n    if (API.commit) {\r\n      API.commit();\r\n    }\r\n\t}\r\n  \r\n  function updateChecked() {\r\n    for (const menu of dynamicChecked) {\r\n      API.update(menu.id, {checked: menu.checked()});\r\n    }\r\n  }\r\n}\r\n\r\nmodule.exports = webextMenus;\r\n"],"names":["polyfillVisible","MENUS","ids","Map","scopes","ALL_CONTEXTS","ALL_CONTEXTS_EXCLUDE","Set","Object","values","ContextType","filter","c","has","getAllContexts","INC","create","options","visible","id","assign","menu","rawOptions","pendingVisible","prev","refreshed","set","contextName","contexts","getContexts","parentId","get","reduce","context","forEach","add","scopeName","lastMenu","push","update","props","commit","some","m","remove","menus","useVisible","BROWSER","browser","chrome","contextMenus","getMenusAPI","dynamicMenus","dynamicChecked","API","title","runtime","lastError","console","warn","err","checkVisible","checked","oncontext","show","init","shouldShow","Boolean","updateShown","updateChecked"],"mappings":"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"}