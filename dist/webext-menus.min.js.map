{"version":3,"file":"webext-menus.min.js","sources":["../index.js"],"sourcesContent":["function polyfillVisible(MENUS) {\r\n  const ids = new Map; // Map<id, menu>\r\n  const scopes = new Map; // Map<scopeId, menu>\r\n  const ALL_CONTEXTS = getAllContexts(MENUS);\r\n  return {\r\n    create,\r\n    // remove,\r\n    update,\r\n    commit\r\n  };\r\n  \r\n\tfunction normalizeContexts(contexts) {\r\n    // convert \"all\" to an array of names\r\n\t\treturn contexts.reduce((set, context) => {\r\n      if (context === \"all\") {\r\n        ALL_CONTEXTS.forEach(c => set.add(c));\r\n      } else {\r\n        set.add(context);\r\n      }\r\n\t\t\treturn set;\r\n\t\t}, new Set);\r\n\t}\r\n\t\r\n\tfunction getContexts(menu) {\r\n\t\tif (menu.rawOptions.contexts) {\r\n\t\t\treturn menu.rawOptions.contexts;\r\n\t\t}\r\n\t\tif (menu.rawOptions.parentId != null) {\r\n\t\t\treturn getContexts(ids.get(menu.rawOptions.parentId));\r\n\t\t}\r\n\t\treturn [\"page\"];\r\n\t}\r\n\t\r\n  function create(options, callback) {\r\n    // NOTE: can't reuse the same object since Chrome tries modifying it.\r\n    const id = MENUS.create(Object.assign({}, options), callback);\r\n    const menu = {\r\n      id,\r\n      rawOptions: options,\r\n      visible: true,\r\n      pendingVisible: null,\r\n      prev: [],\r\n      refreshed: false\r\n    };\r\n    ids.set(id, menu);\r\n    for (const contextName of normalizeContexts(getContexts(menu))) {\r\n      const scopeName = `${options.parentId}/${contextName}`;\r\n      const lastMenu = scopes.get(scopeName);\r\n      if (lastMenu) {\r\n        menu.prev.push(lastMenu);\r\n      }\r\n      scopes.set(scopeName, menu);\r\n    }\r\n    return id;\r\n  }\r\n  \r\n  // function remove(id) {\r\n    // FIXME: incomplete API, no one use this\r\n    // ids.delete(id);\r\n    // return MENUS.remove(id);\r\n  // }\r\n  \r\n  function update(id, props) {\r\n    // FIXME: Doesn't support update `contexts`, `parentId`\r\n    const menu = ids.get(id);\r\n    if (props.visible != null) {\r\n      if (props.visible !== menu.visible) {\r\n        menu.pendingVisible = props.visible;\r\n      }\r\n      delete props.visible;\r\n    }\r\n    // FIXME: should we check Object.keys(menu).length and bail out?\r\n    Object.assign(menu.rawOptions, props);\r\n    if (menu.visible) {\r\n      return MENUS.update(id, props);\r\n    }\r\n  }\r\n  \r\n  function commit() {\r\n    // FIXME: we rely on the insertion order. Is it gaurateed in `Set`?\r\n    for (const menu of ids.values()) {\r\n      if (menu.prev.some(m => m.refreshed)) {\r\n        menu.refreshed = true;\r\n        if (menu.pendingVisible == null && menu.visible) {\r\n          // remove static shown menus and create again\r\n          MENUS.remove(menu.id);\r\n          menu.pendingVisible = true;\r\n        }\r\n      }\r\n      if (menu.pendingVisible === false) {\r\n        // remove dynamic menu\r\n        MENUS.remove(menu.id);\r\n        menu.visible = false;\r\n        menu.pendingVisible = null;\r\n      } else if (menu.pendingVisible === true) {\r\n        // show dynamic menu and mark as refreshed\r\n        MENUS.create(menu.rawOptions);\r\n        menu.visible = true;\r\n        menu.pendingVisible = null;\r\n        menu.refreshed = true;\r\n      }\r\n    }\r\n    for (const menu of ids.values()) {\r\n      menu.refreshed = false;\r\n    }\r\n  }\r\n}\r\n\r\nfunction getMenusAPI() {\r\n  const BROWSER = typeof browser !== \"undefined\" ? browser : chrome; // eslint-disable-line no-undef\r\n  return BROWSER.menus || BROWSER.contextMenus;\r\n}\r\n\r\nfunction getAllContexts(MENUS) {\r\n  const ALL_CONTEXTS_EXCLUDE = new Set([\r\n    \"all\",\r\n    \"bookmark\",\r\n    \"browser_action\",\r\n    \"launcher\",\r\n    \"page_action\",\r\n    \"tab\",\r\n    \"tools_menu\"\r\n  ]);\r\n  return Object.values(MENUS.ContextType)\r\n    .filter(c => !ALL_CONTEXTS_EXCLUDE.has(c));\r\n}\r\n\r\nfunction checkVisible(MENUS) {\r\n  let id;\r\n  try {\r\n    id = MENUS.create({visible: false}, () => {\r\n      // eslint-disable-next-line no-undef\r\n      const BROWSER = typeof browser !== \"undefined\" ? browser : chrome;\r\n      if (BROWSER.runtime.lastError) {\r\n        console.warn(\"failed to create menu when checking visible property\", BROWSER.runtime.lastError);\r\n      }\r\n    });\r\n    return true;\r\n  } catch (err) {\r\n    return false;\r\n  } finally {\r\n    if (id != null) {\r\n      MENUS.remove(id); // FIXME: shuould we catch remove errors?\r\n    }\r\n  }\r\n}\r\n\r\nfunction webextMenus(menus, useVisible) {\r\n  const MENUS = getMenusAPI();\r\n\tconst dynamicMenus = [];\r\n  const dynamicChecked = [];\r\n  const API = (useVisible == null ? checkVisible(MENUS) : useVisible) ?\r\n    MENUS : polyfillVisible(MENUS);\r\n\t\r\n  init();\r\n  \r\n\treturn {update};\r\n\t\r\n\tfunction init() {\r\n\t\tfor (const menu of menus) {\r\n\t\t\t// raw options object for browser.menus.create\r\n\t\t\tmenu.options = Object.assign({}, menu);\r\n\t\t\t\r\n      // mark as dynamic checked\r\n      if (typeof menu.checked === \"function\") {\r\n        delete menu.options.checked;\r\n        dynamicChecked.push(menu);\r\n      }\r\n      \r\n\t\t\t// mark as dynamic\r\n\t\t\tif (menu.oncontext) {\r\n        delete menu.options.oncontext;\r\n\t\t\t\tdynamicMenus.push(menu);\r\n        menu.show = false;\r\n        menu.options.visible = false;\r\n\t\t\t} else {\r\n        menu.show = true;\r\n      }\r\n      \r\n      menu.id = menu.options.id = API.create(Object.assign({}, menu.options));\r\n    }\r\n\t}\r\n\t\r\n  function update() {\r\n    updateShown();\r\n    updateChecked();\r\n  }\r\n\t\r\n\tfunction updateShown() {\r\n\t\tfor (const menu of dynamicMenus) {\r\n\t\t\tconst shouldShow = Boolean(menu.oncontext());\r\n\t\t\tif (menu.show === shouldShow) continue;\r\n\t\t\t\r\n      menu.show = shouldShow;\r\n      menu.options.visible = shouldShow;\r\n      API.update(menu.id, {visible: shouldShow});\r\n\t\t}\r\n    if (API.commit) {\r\n      API.commit();\r\n    }\r\n\t}\r\n  \r\n  function updateChecked() {\r\n    for (const menu of dynamicChecked) {\r\n      API.update(menu.id, {checked: menu.checked()});\r\n    }\r\n  }\r\n}\r\n\r\nmodule.exports = webextMenus;\r\n"],"names":["polyfillVisible","MENUS","ids","Map","scopes","ALL_CONTEXTS","ALL_CONTEXTS_EXCLUDE","Set","Object","values","ContextType","filter","c","has","getAllContexts","create","options","callback","id","assign","menu","rawOptions","visible","pendingVisible","prev","refreshed","set","contextName","contexts","getContexts","parentId","get","reduce","context","forEach","add","scopeName","lastMenu","push","update","props","commit","some","m","remove","menus","useVisible","BROWSER","browser","chrome","contextMenus","getMenusAPI","dynamicMenus","dynamicChecked","API","runtime","lastError","console","warn","err","checkVisible","checked","oncontext","show","init","shouldShow","Boolean","updateShown","updateChecked"],"mappings":"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"}