{"version":3,"file":"webext-menus.min.js","sources":["../index.js"],"sourcesContent":["const BROWSER = typeof browser !== \"undefined\" ? browser : chrome; // eslint-disable-line no-undef\r\nconst MENUS = BROWSER.menus || BROWSER.contextMenus;\r\nconst ALL_CONTEXTS_EXCLUDE = new Set([\r\n  \"all\",\r\n  \"bookmark\",\r\n  \"browser_action\",\r\n  \"launcher\",\r\n  \"page_action\",\r\n  \"tab\",\r\n  \"tools_menu\"\r\n]);\r\nconst ALL_CONTEXTS = Object.values(MENUS.ContextType)\r\n  .filter(c => !ALL_CONTEXTS_EXCLUDE.has(c));\r\nconst SUPPORT_VISIBLE = (() => {\r\n  try {\r\n    const id = MENUS.create({visible: false});\r\n    MENUS.remove(id);\r\n    return true;\r\n  } catch (err) {\r\n    return false;\r\n  }\r\n})();\r\n\r\nfunction destroy(menu) {\r\n  MENUS.remove(menu.id);\r\n  menu.isCreated = false;\r\n}\r\n\r\nfunction createVisibleUpdater() {\r\n  return {createHidden, toggleVisible};\r\n  \r\n  function createHidden(menu) {\r\n    menu.options.visible = false;\r\n    create(menu);\r\n  }\r\n  \r\n  function toggleVisible(menus) {\r\n    for (const menu of menus) {\r\n      menu.options.visible = menu.show;\r\n      MENUS.update(menu.id, {visible: menu.show});\r\n    }\r\n  }\r\n}\r\n\r\nfunction createLegacyVisibleUpdater() {\r\n  const ids = new Map;\r\n  return {toggleVisible, init};\r\n  \r\n  function toggleVisible(menus) {\r\n    for (const menu of menus) {\r\n      if (!menu.show) {\r\n        destroy(menu);\r\n      }\r\n    }\r\n    \r\n    for (const menu of menus) {\r\n      if (menu.show) {\r\n        if (menu.isCreated) {\r\n          // already processed\r\n          continue;\r\n        }\r\n        destroySiblings(menu);\r\n        create(menu);\r\n        createSiblings(menu);\r\n      }\r\n    }\r\n  }\r\n  \r\n\tfunction destroySiblings(menu) {\r\n\t\tif (!menu.nextSibling) return;\r\n\t\tfor (const nextMenu of Object.values(menu.nextSibling)) {\r\n\t\t\tif (nextMenu.isCreated) {\r\n\t\t\t\tdestroy(nextMenu);\r\n\t\t\t}\r\n\t\t\tdestroySiblings(nextMenu);\r\n\t\t}\r\n\t}\r\n\t\r\n\tfunction createSiblings(menu) {\r\n\t\tif (!menu.nextSibling) return;\r\n\t\tfor (const nextMenu of Object.values(menu.nextSibling)) {\r\n\t\t\tif (!nextMenu.isCreated && nextMenu.show) {\r\n\t\t\t\tcreate(nextMenu);\r\n\t\t\t}\r\n\t\t\tcreateSiblings(nextMenu);\r\n\t\t}\r\n\t}\r\n\t\r\n  function init(menus) {\r\n\t\tconst prevSibling = {};\r\n    for (const menu of menus) {\r\n      // save id\r\n      if (menu.id != null) {\r\n        ids.set(menu.id, menu);\r\n      }\r\n      // build sibling relationship\r\n      for (const context of reduceContextType(getMenuContext(menu))) {\r\n        if (!prevSibling[context]) {\r\n          prevSibling[context] = new Map;\r\n        }\r\n        const prevCmd = prevSibling[context].get(menu.parentId);\r\n        if (prevCmd) {\r\n          if (!prevCmd.nextSibling) {\r\n            prevCmd.nextSibling = {};\r\n          }\r\n          prevCmd.nextSibling[context] = menu;\r\n        }\r\n        prevSibling[context].set(menu.parentId, menu);\r\n      }\r\n    }\r\n  }\r\n  \r\n\tfunction reduceContextType(contexts) {\r\n\t\treturn contexts.reduce((set, context) => {\r\n      if (context === \"all\") {\r\n        ALL_CONTEXTS.forEach(c => set.add(c));\r\n      } else {\r\n        set.add(context);\r\n      }\r\n\t\t\treturn set;\r\n\t\t}, new Set);\r\n\t}\r\n\t\r\n\tfunction getMenuContext(menu) {\r\n\t\tif (menu.contexts) {\r\n\t\t\treturn menu.contexts;\r\n\t\t}\r\n\t\tif (menu.parentId != null) {\r\n\t\t\treturn getMenuContext(ids.get(menu.parentId));\r\n\t\t}\r\n\t\treturn [\"page\"];\r\n\t}\r\n\t\r\n}\r\n\r\nfunction create(menu) {\r\n  menu.id = MENUS.create(Object.assign({}, menu.options));\r\n  menu.isCreated = true;\r\n}\r\n\r\nfunction webextMenus(menus, _SUPPORT_VISIBLE = SUPPORT_VISIBLE) {\r\n\tconst dynamicMenus = [];\r\n  const dynamicChecked = [];\r\n  const visibleUpdater = _SUPPORT_VISIBLE ? createVisibleUpdater() : createLegacyVisibleUpdater();\r\n\t\r\n\tinit(menus);\r\n\t\r\n\tfunction init(menus) {\r\n\t\tfor (const menu of menus) {\r\n\t\t\t// raw options object for browser.menus.create\r\n\t\t\tmenu.options = Object.assign({}, menu);\r\n\t\t\t\r\n      // mark as dynamic checked\r\n      if (typeof menu.checked === \"function\") {\r\n        delete menu.options.checked;\r\n        dynamicChecked.push(menu);\r\n      }\r\n      \r\n\t\t\t// mark as dynamic\r\n\t\t\tif (menu.oncontext) {\r\n        delete menu.options.oncontext;\r\n\t\t\t\tdynamicMenus.push(menu);\r\n        menu.show = false;\r\n        if (visibleUpdater.createHidden) {\r\n          visibleUpdater.createHidden(menu);\r\n        }\r\n\t\t\t} else {\r\n        menu.show = true;\r\n        create(menu);\r\n      }\r\n    }\r\n    \r\n    if (visibleUpdater.init) {\r\n      visibleUpdater.init(menus);\r\n    }\r\n\t}\r\n\t\r\n  function update() {\r\n    updateShown();\r\n    updateChecked();\r\n  }\r\n\t\r\n\tfunction updateShown() {\r\n\t\tconst changed = [];\r\n\t\tfor (const menu of dynamicMenus) {\r\n\t\t\tconst shouldShow = Boolean(menu.oncontext());\r\n\t\t\tif (menu.show === shouldShow) continue;\r\n\t\t\t\r\n      menu.show = shouldShow;\r\n      changed.push(menu);\r\n\t\t}\r\n    visibleUpdater.toggleVisible(changed);\r\n\t}\r\n  \r\n  function updateChecked() {\r\n    for (const menu of dynamicChecked) {\r\n      MENUS.update(menu.id, {checked: menu.checked()});\r\n    }\r\n  }\r\n\t\r\n\treturn {update};\r\n}\r\n\r\nmodule.exports = webextMenus;\r\n"],"names":["BROWSER","browser","chrome","MENUS","menus","contextMenus","ALL_CONTEXTS_EXCLUDE","Set","ALL_CONTEXTS","Object","values","ContextType","filter","c","has","SUPPORT_VISIBLE","id","create","visible","remove","err","destroy","menu","isCreated","assign","options","_SUPPORT_VISIBLE","dynamicMenus","dynamicChecked","visibleUpdater","createHidden","toggleVisible","show","update","ids","Map","destroySiblings","createSiblings","init","prevSibling","set","context","getMenuContext","reduce","forEach","add","prevCmd","get","parentId","nextSibling","nextMenu","contexts","createLegacyVisibleUpdater","checked","push","oncontext","changed","shouldShow","Boolean","updateShown","updateChecked"],"mappings":"wCAAA,MAAMA,EAA6B,oBAAZC,QAA0BA,QAAUC,OACrDC,EAAQH,EAAQI,OAASJ,EAAQK,aACjCC,EAAuB,IAAIC,IAAI,CACnC,MACA,WACA,iBACA,WACA,cACA,MACA,eAEIC,EAAeC,OAAOC,OAAOP,EAAMQ,aACtCC,OAAOC,IAAMP,EAAqBQ,IAAID,IACnCE,EAAkB,MACtB,IACE,MAAMC,EAAKb,EAAMc,OAAO,CAACC,SAAS,IAElC,OADAf,EAAMgB,OAAOH,IACN,EACP,MAAOI,GACP,OAAO,IANa,GAUxB,SAASC,EAAQC,GACfnB,EAAMgB,OAAOG,EAAKN,IAClBM,EAAKC,WAAY,EA8GnB,SAASN,EAAOK,GACdA,EAAKN,GAAKb,EAAMc,OAAOR,OAAOe,OAAO,GAAIF,EAAKG,UAC9CH,EAAKC,WAAY,SAGnB,SAAqBnB,EAAOsB,EAAmBX,GAC9C,MAAMY,EAAe,GACdC,EAAiB,GACjBC,EAAiBH,EAlHhB,CAACI,aAER,SAAsBR,GACpBA,EAAKG,QAAQP,SAAU,EACvBD,EAAOK,IAJaS,cAOtB,SAAuB3B,GACrB,IAAK,MAAMkB,KAAQlB,EACjBkB,EAAKG,QAAQP,QAAUI,EAAKU,KAC5B7B,EAAM8B,OAAOX,EAAKN,GAAI,CAACE,QAASI,EAAKU,SAK3C,WACE,MAAME,EAAM,IAAIC,IAChB,MAAO,CAACJ,cAER,SAAuB3B,GACrB,IAAK,MAAMkB,KAAQlB,EACZkB,EAAKU,MACRX,EAAQC,GAIZ,IAAK,MAAMA,KAAQlB,EACjB,GAAIkB,EAAKU,KAAM,CACb,GAAIV,EAAKC,UAEP,SAEFa,EAAgBd,GAChBL,EAAOK,GACPe,EAAef,KAjBEgB,KA0CvB,SAAclC,GACd,MAAMmC,EAAc,GAClB,IAAK,MAAMjB,KAAQlB,EAAO,CAET,MAAXkB,EAAKN,IACPkB,EAAIM,IAAIlB,EAAKN,GAAIM,GAGnB,IAAK,MAAMmB,KAA6BC,EAAepB,GAiB3CqB,OAAO,CAACH,EAAKC,KACT,QAAZA,EACFjC,EAAaoC,QAAQ/B,GAAK2B,EAAIK,IAAIhC,IAElC2B,EAAIK,IAAIJ,GAEND,GACL,IAAIjC,KAxB4D,CACxDgC,EAAYE,KACfF,EAAYE,GAAW,IAAIN,KAE7B,MAAMW,EAAUP,EAAYE,GAASM,IAAIzB,EAAK0B,UAC1CF,IACGA,EAAQG,cACXH,EAAQG,YAAc,IAExBH,EAAQG,YAAYR,GAAWnB,GAEjCiB,EAAYE,GAASD,IAAIlB,EAAK0B,SAAU1B,OAvC/C,SAASc,EAAgBd,GACxB,GAAKA,EAAK2B,YACV,IAAK,MAAMC,KAAYzC,OAAOC,OAAOY,EAAK2B,aACrCC,EAAS3B,WACZF,EAAQ6B,GAETd,EAAgBc,GAIlB,SAASb,EAAef,GACvB,GAAKA,EAAK2B,YACV,IAAK,MAAMC,KAAYzC,OAAOC,OAAOY,EAAK2B,cACpCC,EAAS3B,WAAa2B,EAASlB,MACnCf,EAAOiC,GAERb,EAAea,GAuCjB,SAASR,EAAepB,GACvB,OAAIA,EAAK6B,SACD7B,EAAK6B,SAEQ,MAAjB7B,EAAK0B,SACDN,EAAeR,EAAIa,IAAIzB,EAAK0B,WAE7B,CAAC,SAa2DI,GAyDpE,OArDA,SAAchD,GACb,IAAK,MAAMkB,KAAQlB,EAElBkB,EAAKG,QAAUhB,OAAOe,OAAO,GAAIF,GAGF,mBAAjBA,EAAK+B,iBACP/B,EAAKG,QAAQ4B,QACpBzB,EAAe0B,KAAKhC,IAIrBA,EAAKiC,kBACGjC,EAAKG,QAAQ8B,UACxB5B,EAAa2B,KAAKhC,GACdA,EAAKU,MAAO,EACRH,EAAeC,cACjBD,EAAeC,aAAaR,KAG9BA,EAAKU,MAAO,EACZf,EAAOK,IAIPO,EAAeS,MACjBT,EAAeS,KAAKlC,GA5BzBkC,CAAKlC,GAuDE,CAAC6B,OAvBP,YAKD,WACC,MAAMuB,EAAU,GAChB,IAAK,MAAMlC,KAAQK,EAAc,CAChC,MAAM8B,EAAaC,QAAQpC,EAAKiC,aAC5BjC,EAAKU,OAASyB,IAEfnC,EAAKU,KAAOyB,EACZD,EAAQF,KAAKhC,IAEfO,EAAeE,cAAcyB,GAb7BG,GAgBF,WACE,IAAK,MAAMrC,KAAQM,EACjBzB,EAAM8B,OAAOX,EAAKN,GAAI,CAACqC,QAAS/B,EAAK+B,YAjBvCO"}